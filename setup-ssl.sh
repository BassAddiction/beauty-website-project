#!/bin/bash

# ============================================
# –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê SSL –î–õ–Ø SPEED VPN
# ============================================
# 
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
# - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç DNS –∑–∞–ø–∏—Å–∏
# - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Certbot
# - –ü–æ–ª—É—á–∞–µ—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è –¥–æ–º–µ–Ω–∞ –∏ API —Å—É–±–¥–æ–º–µ–Ω–∞
# - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
# - –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–æ–µ–∫—Ç–∞

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}"
echo "============================================"
echo "   –£–°–¢–ê–ù–û–í–ö–ê SSL –°–ï–†–¢–ò–§–ò–ö–ê–¢–û–í"
echo "   Speed VPN - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞"
echo "============================================"
echo -e "${NC}"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–æ–∫
error() {
    echo -e "${RED}[–û–®–ò–ë–ö–ê] $1${NC}"
    exit 1
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —É—Å–ø–µ—Ö–∞
success() {
    echo -e "${GREEN}[OK] $1${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
warning() {
    echo -e "${YELLOW}[!] $1${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
info() {
    echo -e "${BLUE}[i] $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –æ—Ç root
if [ "$EUID" -ne 0 ]; then 
    error "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ—Ç root: sudo bash setup-ssl.sh"
fi

# ============================================
# –®–ê–ì 1: –ó–ê–ü–†–û–° –î–ê–ù–ù–´–•
# ============================================

echo ""
info "–®–∞–≥ 1: –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
echo ""

read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: example.com): " MAIN_DOMAIN
read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Let's Encrypt: " EMAIL

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤–≤–µ–¥–µ–Ω—ã
if [ -z "$MAIN_DOMAIN" ] || [ -z "$EMAIL" ]; then
    error "–î–æ–º–µ–Ω –∏ email –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è"
fi

API_DOMAIN="api.$MAIN_DOMAIN"

echo ""
info "–ë—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è:"
echo "  - $MAIN_DOMAIN (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç)"
echo "  - $API_DOMAIN (API —Å–µ—Ä–≤–µ—Ä)"
echo ""

read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " CONFIRM
if [ "$CONFIRM" != "y" ] && [ "$CONFIRM" != "Y" ]; then
    warning "–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
    exit 0
fi

# ============================================
# –®–ê–ì 2: –ü–†–û–í–ï–†–ö–ê DNS
# ============================================

echo ""
info "–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS –∑–∞–ø–∏—Å–µ–π"
echo ""

# –ü–æ–ª—É—á–∞–µ–º IP —Å–µ—Ä–≤–µ—Ä–∞
SERVER_IP=$(curl -s ifconfig.me)
success "IP –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞: $SERVER_IP"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞
info "–ü—Ä–æ–≤–µ—Ä—è—é DNS –¥–ª—è $MAIN_DOMAIN..."
MAIN_IP=$(dig +short $MAIN_DOMAIN | tail -n1)

if [ -z "$MAIN_IP" ]; then
    error "DNS –∑–∞–ø–∏—Å—å –¥–ª—è $MAIN_DOMAIN –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –°–æ–∑–¥–∞–π—Ç–µ A –∑–∞–ø–∏—Å—å: $MAIN_DOMAIN ‚Üí $SERVER_IP"
fi

if [ "$MAIN_IP" != "$SERVER_IP" ]; then
    warning "DNS –¥–ª—è $MAIN_DOMAIN —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ $MAIN_IP, –Ω–æ –≤–∞—à —Å–µ—Ä–≤–µ—Ä $SERVER_IP"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ? (y/n): " CONTINUE
    if [ "$CONTINUE" != "y" ] && [ "$CONTINUE" != "Y" ]; then
        error "–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ DNS –ø—Ä–∞–≤–∏–ª—å–Ω–æ: $MAIN_DOMAIN ‚Üí $SERVER_IP"
    fi
else
    success "DNS –¥–ª—è $MAIN_DOMAIN –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API —Å—É–±–¥–æ–º–µ–Ω–∞
info "–ü—Ä–æ–≤–µ—Ä—è—é DNS –¥–ª—è $API_DOMAIN..."
API_IP=$(dig +short $API_DOMAIN | tail -n1)

if [ -z "$API_IP" ]; then
    error "DNS –∑–∞–ø–∏—Å—å –¥–ª—è $API_DOMAIN –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –°–æ–∑–¥–∞–π—Ç–µ A –∑–∞–ø–∏—Å—å: api ‚Üí $SERVER_IP"
fi

if [ "$API_IP" != "$SERVER_IP" ]; then
    warning "DNS –¥–ª—è $API_DOMAIN —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ $API_IP, –Ω–æ –≤–∞—à —Å–µ—Ä–≤–µ—Ä $SERVER_IP"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ? (y/n): " CONTINUE
    if [ "$CONTINUE" != "y" ] && [ "$CONTINUE" != "Y" ]; then
        error "–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ DNS –ø—Ä–∞–≤–∏–ª—å–Ω–æ: api.$MAIN_DOMAIN ‚Üí $SERVER_IP"
    fi
else
    success "DNS –¥–ª—è $API_DOMAIN –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
fi

# ============================================
# –®–ê–ì 3: –£–°–¢–ê–ù–û–í–ö–ê CERTBOT
# ============================================

echo ""
info "–®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot"
echo ""

if command -v certbot &> /dev/null; then
    success "Certbot —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    info "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Certbot..."
    apt update -qq
    apt install -y certbot python3-certbot-nginx > /dev/null 2>&1
    success "Certbot —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# ============================================
# –®–ê–ì 4: –û–°–¢–ê–ù–û–í–ö–ê NGINX
# ============================================

echo ""
info "–®–∞–≥ 4: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–æ–ª—É—á–µ–Ω–∏—é —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—â–µ–Ω –ª–∏ Docker Compose
if docker compose ps | grep -q "nginx"; then
    info "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Docker Compose –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–æ–≤ 80/443..."
    docker compose down
    success "Docker Compose –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ—Ä—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã
if netstat -tulpn | grep -q ":80 "; then
    warning "–ü–æ—Ä—Ç 80 –∑–∞–Ω—è—Ç. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–æ—Ü–µ—Å—Å—ã..."
    fuser -k 80/tcp || true
fi

if netstat -tulpn | grep -q ":443 "; then
    warning "–ü–æ—Ä—Ç 443 –∑–∞–Ω—è—Ç. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–æ—Ü–µ—Å—Å—ã..."
    fuser -k 443/tcp || true
fi

sleep 2
success "–ü–æ—Ä—Ç—ã 80 –∏ 443 —Å–≤–æ–±–æ–¥–Ω—ã"

# ============================================
# –®–ê–ì 5: –ü–û–õ–£–ß–ï–ù–ò–ï –°–ï–†–¢–ò–§–ò–ö–ê–¢–û–í
# ============================================

echo ""
info "–®–∞–≥ 5: –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
echo ""

# –í–∞—Ä–∏–∞–Ω—Ç 1: –û–¥–∏–Ω —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –æ–±–æ–∏—Ö –¥–æ–º–µ–Ω–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
info "–ü–æ–ª—É—á–∞—é SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è $MAIN_DOMAIN –∏ $API_DOMAIN..."

certbot certonly \
    --standalone \
    --non-interactive \
    --agree-tos \
    --email "$EMAIL" \
    -d "$MAIN_DOMAIN" \
    -d "$API_DOMAIN" \
    || error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–æ–≤ 80/443"

success "SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–æ–∑–¥–∞–Ω—ã
if [ ! -f "/etc/letsencrypt/live/$MAIN_DOMAIN/fullchain.pem" ]; then
    error "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ /etc/letsencrypt/live/$MAIN_DOMAIN/"
fi

# ============================================
# –®–ê–ì 6: –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ê–í –î–û–°–¢–£–ü–ê
# ============================================

echo ""
info "–®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º"
echo ""

chmod 755 /etc/letsencrypt/live/
chmod 755 /etc/letsencrypt/archive/
chmod 644 /etc/letsencrypt/live/$MAIN_DOMAIN/fullchain.pem
chmod 600 /etc/letsencrypt/live/$MAIN_DOMAIN/privkey.pem

success "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"

# ============================================
# –®–ê–ì 7: –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
# ============================================

echo ""
info "–®–∞–≥ 7: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
echo ""

# –û–±–Ω–æ–≤–ª—è–µ–º nginx.conf
if [ -f "nginx/nginx.conf" ]; then
    info "–û–±–Ω–æ–≤–ª—è—é nginx/nginx.conf..."
    
    # –ó–∞–º–µ–Ω—è–µ–º yourdomain.com –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω
    sed -i "s/yourdomain\.com/$MAIN_DOMAIN/g" nginx/nginx.conf
    
    success "nginx.conf –æ–±–Ω–æ–≤–ª–µ–Ω"
else
    warning "–§–∞–π–ª nginx/nginx.conf –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# –û–±–Ω–æ–≤–ª—è–µ–º .env —Ñ–∞–π–ª (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
if [ -f ".env" ]; then
    info "–û–±–Ω–æ–≤–ª—è—é .env —Ñ–∞–π–ª..."
    
    # –û–±–Ω–æ–≤–ª—è–µ–º URL –¥–æ–º–µ–Ω—ã
    sed -i "s|# VITE_API_URL=https://api\.yourdomain\.com|VITE_API_URL=https://$API_DOMAIN|g" .env
    sed -i "s|# FRONTEND_URL=https://yourdomain\.com|FRONTEND_URL=https://$MAIN_DOMAIN|g" .env
    sed -i "s|# BACKEND_URL=https://api\.yourdomain\.com|BACKEND_URL=https://$API_DOMAIN|g" .env
    
    # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∏ —É–∂–µ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
    sed -i "s|VITE_API_URL=.*|VITE_API_URL=https://$API_DOMAIN|g" .env
    sed -i "s|FRONTEND_URL=.*|FRONTEND_URL=https://$MAIN_DOMAIN|g" .env
    sed -i "s|BACKEND_URL=.*|BACKEND_URL=https://$API_DOMAIN|g" .env
    
    success ".env —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω"
else
    warning ".env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –∏–∑ .env.example"
fi

# ============================================
# –®–ê–ì 8: –ù–ê–°–¢–†–û–ô–ö–ê –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–Ø
# ============================================

echo ""
info "–®–∞–≥ 8: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
echo ""

# –°–æ–∑–¥–∞–µ–º hook –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Nginx –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
mkdir -p /etc/letsencrypt/renewal-hooks/deploy

PROJECT_DIR=$(pwd)

cat > /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh << EOF
#!/bin/bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
cd $PROJECT_DIR
docker compose restart nginx
EOF

chmod +x /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–∞–π–º–µ—Ä Certbot –∞–∫—Ç–∏–≤–µ–Ω
if systemctl is-active --quiet certbot.timer; then
    success "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"
else
    systemctl enable certbot.timer
    systemctl start certbot.timer
    success "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"
fi

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
info "–¢–µ—Å—Ç–∏—Ä—É—é –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (dry run)..."
certbot renew --dry-run > /dev/null 2>&1 && success "–¢–µ—Å—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–π–¥–µ–Ω" || warning "–¢–µ—Å—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"

# ============================================
# –®–ê–ì 9: –ó–ê–ü–£–°–ö –ü–†–û–ï–ö–¢–ê
# ============================================

echo ""
info "–®–∞–≥ 9: –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ —Å HTTPS"
echo ""

info "–ó–∞–ø—É—Å–∫–∞—é Docker Compose..."
docker compose up -d --build

# –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥ –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—Å—Ç—è—Ç—Å—è
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
if docker compose ps | grep -q "Up"; then
    success "Docker Compose –∑–∞–ø—É—â–µ–Ω"
else
    warning "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: docker compose ps"
fi

# ============================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê
# ============================================

echo ""
info "–®–∞–≥ 10: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã HTTPS"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω
info "–ü—Ä–æ–≤–µ—Ä—è—é $MAIN_DOMAIN..."
if curl -s -o /dev/null -w "%{http_code}" "https://$MAIN_DOMAIN" | grep -q "200\|301\|302"; then
    success "https://$MAIN_DOMAIN —Ä–∞–±–æ—Ç–∞–µ—Ç!"
else
    warning "https://$MAIN_DOMAIN –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker compose logs nginx"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º API
info "–ü—Ä–æ–≤–µ—Ä—è—é $API_DOMAIN/health..."
if curl -s "https://$API_DOMAIN/health" | grep -q "ok"; then
    success "https://$API_DOMAIN/health —Ä–∞–±–æ—Ç–∞–µ—Ç!"
else
    warning "https://$API_DOMAIN/health –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker compose logs backend"
fi

# ============================================
# –ò–¢–û–ì–ò
# ============================================

echo ""
echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}   ‚úÖ SSL –°–ï–†–¢–ò–§–ò–ö–ê–¢–´ –£–°–¢–ê–ù–û–í–õ–ï–ù–´!${NC}"
echo -e "${GREEN}============================================${NC}"
echo ""
echo -e "${BLUE}üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:${NC}"
echo ""
echo "  üåê –û—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç:    https://$MAIN_DOMAIN"
echo "  üîå API —Å–µ—Ä–≤–µ—Ä:       https://$API_DOMAIN"
echo "  üìß Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: $EMAIL"
echo "  üîê –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã:      /etc/letsencrypt/live/$MAIN_DOMAIN/"
echo "  üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:   –í–∫–ª—é—á–µ–Ω–æ (–∫–∞–∂–¥—ã–µ 90 –¥–Ω–µ–π)"
echo ""
echo -e "${BLUE}üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:${NC}"
echo ""
echo "  –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:     docker compose ps"
echo "  –õ–æ–≥–∏ Nginx:           docker compose logs nginx"
echo "  –õ–æ–≥–∏ Backend:         docker compose logs backend"
echo "  –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é:     certbot renew"
echo "  –°—Ç–∞—Ç—É—Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:  certbot certificates"
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  –í–∞–∂–Ω–æ:${NC}"
echo ""
echo "  - –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–µ–π—Å—Ç–≤—É—é—Ç 90 –¥–Ω–µ–π"
echo "  - Certbot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç –∏—Ö –∑–∞ 30 –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è"
echo "  - Nginx –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
echo ""
echo -e "${GREEN}üöÄ –í–∞—à Speed VPN –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!${NC}"
echo ""
