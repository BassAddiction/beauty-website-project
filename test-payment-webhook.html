<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Webhook - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        h1 {
            color: #4ade80;
        }
        button {
            background: #4ade80;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            margin: 10px 5px;
        }
        button:hover {
            background: #22c55e;
        }
        pre {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333;
        }
        .success { color: #4ade80; }
        .error { color: #ef4444; }
        .info { color: #60a5fa; }
        input {
            background: #0a0a0a;
            border: 1px solid #333;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            width: 300px;
            margin: 10px 5px;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç Webhook - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã</h1>
    
    <div>
        <input type="text" id="username" placeholder="Username (–Ω–∞–ø—Ä–∏–º–µ—Ä: test_user_123)" value="test_user_auto_create">
        <input type="number" id="days" placeholder="–î–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏" value="30">
        <br>
        <button onclick="testWebhook()">üöÄ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É (webhook)</button>
        <button onclick="checkUser()">üë§ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    </div>
    
    <pre id="output">–û–∂–∏–¥–∞–Ω–∏–µ...</pre>

    <script>
        const PAYMENT_URL = 'https://functions.poehali.dev/1cd4e8c8-3e41-470f-a824-9c8dd42b6c9c';
        const REMNAWAVE_URL = 'https://functions.poehali.dev/eb10e5f7-d0cf-4bb8-87e0-8af1ce0c85a6';
        
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            const color = type === 'success' ? '#4ade80' : type === 'error' ? '#ef4444' : '#60a5fa';
            output.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        async function testWebhook() {
            const username = document.getElementById('username').value;
            const days = parseInt(document.getElementById('days').value);
            
            if (!username) {
                alert('–£–∫–∞–∂–∏—Ç–µ username!');
                return;
            }
            
            document.getElementById('output').innerHTML = '';
            log('üöÄ –°–ò–ú–£–õ–Ø–¶–ò–Ø WEBHOOK –æ—Ç –ÆKassa...', 'info');
            log(`Username: ${username}, –î–Ω–µ–π: ${days}`, 'info');
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º webhook –æ—Ç –ÆKassa
            const webhookPayload = {
                "type": "notification",
                "event": "payment.succeeded",
                "object": {
                    "id": `test_payment_${Date.now()}`,
                    "status": "succeeded",
                    "amount": {
                        "value": "299.00",
                        "currency": "RUB"
                    },
                    "receipt": {
                        "customer": {
                            "email": "test@example.com"
                        }
                    },
                    "metadata": {
                        "username": username,
                        "plan_name": "–¢–µ—Å—Ç–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ",
                        "plan_days": days.toString()
                    }
                }
            };
            
            try {
                log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ webhook...', 'info');
                const response = await fetch(PAYMENT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookPayload)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Webhook –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    log(`–û—Ç–≤–µ—Ç: ${JSON.stringify(data, null, 2)}`, 'success');
                    
                    // –ñ–¥—ë–º 2 —Å–µ–∫—É–Ω–¥—ã –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    setTimeout(() => checkUser(), 2000);
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ webhook: ${response.status}`, 'error');
                    log(JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function checkUser() {
            const username = document.getElementById('username').value;
            
            if (!username) {
                alert('–£–∫–∞–∂–∏—Ç–µ username!');
                return;
            }
            
            log('\nüë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...', 'info');
            
            try {
                const response = await fetch(`${REMNAWAVE_URL}?username=${username}`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const user = await response.json();
                    log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω!', 'success');
                    log(`Username: ${user.username}`, 'success');
                    log(`Status: ${user.status}`, 'success');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É
                    const expireDate = new Date(user.expire * 1000);
                    log(`Expire: ${user.expire} (${expireDate.toLocaleString('ru-RU')})`, 'success');
                    
                    if (user.expire > 0 && expireDate > new Date()) {
                        log('üéâ –£–°–ü–ï–•! –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!', 'success');
                    } else {
                        log('‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è = 01.01.1970 –∏–ª–∏ –≤ –ø—Ä–æ—à–ª–æ–º', 'error');
                    }
                    
                    log(`Data limit: ${(user.data_limit / 1024 / 1024 / 1024).toFixed(2)} GB`, 'success');
                    log(`Sub URL: ${user.sub_url}`, 'success');
                } else if (response.status === 404) {
                    log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –Ω–∞–π–¥–µ–Ω (404)', 'error');
                    log('–í–æ–∑–º–æ–∂–Ω–æ webhook –Ω–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è', 'error');
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${response.status}`, 'error');
                    const data = await response.text();
                    log(data, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        log('‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!', 'success');
        log('–ù–∞–∂–º–∏—Ç–µ "–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'info');
    </script>
</body>
</html>
